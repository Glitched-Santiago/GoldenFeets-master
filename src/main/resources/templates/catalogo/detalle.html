<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base/base-cliente}">
<head>
    <title th:text="${producto != null ? producto.nombre : 'Detalle'}"></title>
    <style>
        :root { --primary: #111827; --border: #e5e7eb; --radius: 8px; }
        .product-detail-page { padding: 3rem 1rem; max-width: 1200px; margin: 0 auto; }
        .grid-layout { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 968px) { .grid-layout { grid-template-columns: 100px 1fr 400px; gap: 1rem; } }

        .thumbnails { display: flex; flex-direction: row; gap: 10px; overflow-x: auto; }
        @media (min-width: 968px) { .thumbnails { flex-direction: column; overflow-y: auto; max-height: 600px; } }
        .thumb-btn { width: 80px; height: 80px; border-radius: var(--radius); border: 1px solid transparent; cursor: pointer; overflow: hidden; flex-shrink: 0; }
        .thumb-btn:hover, .thumb-btn.active { border-color: var(--primary); }
        .thumb-btn img { width: 100%; height: 100%; object-fit: cover; }

        .main-image-container { position: relative; background: #f9fafb; border-radius: 12px; overflow: hidden; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; }
        .main-image-container img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.2s; }

        .product-title { font-size: 2rem; font-weight: 700; line-height: 1.1; margin-bottom: 0.5rem; }
        .product-price { font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 2rem; }

        .selector-label { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.8rem; display: flex; justify-content: space-between; }
        .color-grid, .size-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; }

        .color-option, .size-option {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 6px;
            cursor: pointer; background: white; user-select: none; transition: 0.2s;
        }
        .color-option.selected, .size-option.selected { border-color: var(--primary); background: var(--primary); color: white; }
        .size-option.disabled { opacity: 0.3; cursor: not-allowed; background: #f3f4f6; text-decoration: line-through; }

        .add-btn { width: 100%; background: var(--primary); color: white; padding: 1.2rem; border-radius: 50px; font-weight: 600; border: none; cursor: pointer; }
        .add-btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        .error-msg { color: #dc2626; font-size: 0.85rem; display: none; margin-top: 5px; }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="product-detail-page" th:if="${producto != null}">

        <div th:if="${successMessage}" class="alert alert-success mb-4" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-error mb-4" th:text="${errorMessage}"></div>

        <div class="grid-layout">
            <div class="thumbnails">
                <div class="thumb-btn active" th:onclick="changeMainImage([[${producto.imagenUrl}]])">
                    <img th:src="${producto.imagenUrl}" onerror="this.src='https://placehold.co/80';">
                </div>
                <th:block th:each="v : ${producto.variantes}">
                    <div th:if="${v.imagenUrl != null and !#strings.isEmpty(v.imagenUrl)}"
                         class="thumb-btn"
                         th:onclick="changeMainImage([[${v.imagenUrl}]])">
                        <img th:src="${v.imagenUrl}" onerror="this.style.display='none'">
                    </div>
                </th:block>
            </div>

            <div class="main-image-container">
                <img id="mainImage" th:src="${producto.imagenUrl}"
                     onerror="this.src='https://placehold.co/600x600?text=Sin+Imagen';">
            </div>

            <div class="info-panel">
                <h1 class="product-title" th:text="${producto.nombre}"></h1>
                <div class="text-gray-500 mb-2" th:text="${producto.categoria?.nombre}"></div>
                <div class="product-price" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 'POINT', 2, 'COMMA')}"></div>

                <form th:action="@{/carrito/agregar/{id}(id=${producto.id})}" method="post" id="addToCartForm">
                    <input type="hidden" name="productoVarianteId" id="selectedVariantId">
                    <input type="hidden" name="cantidad" value="1">

                    <label class="selector-label">Color: <span id="selectedColorText" class="font-normal text-gray-500"></span></label>
                    <div class="color-grid" id="colorContainer"></div>
                    <div id="colorError" class="error-msg">Selecciona un color</div>

                    <label class="selector-label">Talla: <span id="selectedSizeText" class="font-normal text-gray-500"></span></label>
                    <div class="size-grid" id="sizeContainer"></div>
                    <div id="sizeError" class="error-msg">Selecciona una talla</div>

                    <button type="button" id="btnAddToCart" class="add-btn" disabled onclick="submitForm()">
                        Seleccionar opciones
                    </button>
                    <p id="stockDisplay" class="text-center mt-3 text-sm font-medium" style="display:none;"></p>
                </form>

                <div class="mt-8 pt-8 border-t text-gray-600 leading-relaxed" th:text="${producto.descripcion}"></div>
            </div>
        </div>
    </div>

    <div th:if="${producto == null}" class="text-center py-20">
        <h2 class="text-2xl font-bold">Producto no encontrado</h2>
        <a href="/catalogo" class="text-blue-600 underline">Volver al catálogo</a>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const variants = [];
        // Guardamos la imagen original del producto como respaldo
        const mainProductImage = [[${producto != null ? producto.imagenUrl : ''}]];

        /*[# th:if="${producto != null}"]*/
            /*[# th:each="v : ${producto.variantes}"]*/
                /*[# th:if="${v.activo}"]*/
                try {
                    variants.push({
                        id: [[${v.id}]],
                        color: [[${v.color}]],
                        talla: [[${v.talla}]],
                        img: [[${v.imagenUrl != null ? v.imagenUrl : ''}]],
                        stock: [[${v.stock}]]
                    });
                } catch(e) { console.error("Error parsing variant"); }
                /*[/]*/
            /*[/]*/
        /*[/]*/

        // DEBUG: Abre la consola del navegador (F12) para ver esto
        console.log("Variantes cargadas:", variants);

        const colorContainer = document.getElementById('colorContainer');
        const sizeContainer = document.getElementById('sizeContainer');
        const hiddenInput = document.getElementById('selectedVariantId');
        const btnAdd = document.getElementById('btnAddToCart');
        const stockDisplay = document.getElementById('stockDisplay');

        let selectedColor = null;
        let selectedSize = null;

        function init() {
            if(variants.length === 0) return;
            renderColors();
            renderSizes();
        }

        function renderColors() {
            // Normalizamos los colores para evitar duplicados por mayúsculas/espacios
            const uniqueColors = [...new Set(variants.map(v => v.color.trim()))].sort();
            colorContainer.innerHTML = '';
            uniqueColors.forEach(colorName => {
                const div = document.createElement('div');
                div.className = 'color-option';
                div.innerText = colorName; // Mostramos el nombre original
                // Al hacer click, usamos este nombre normalizado
                div.onclick = () => selectColor(colorName, div);
                colorContainer.appendChild(div);
            });
        }

        function renderSizes() {
            const allSizes = [...new Set(variants.map(v => v.talla))].sort((a, b) => a - b);
            sizeContainer.innerHTML = '';

            allSizes.forEach(size => {
                const div = document.createElement('div');
                div.className = 'size-option';
                div.innerText = size;

                let available = false;
                if (selectedColor) {
                    // Comparación segura de color (minúsculas y sin espacios)
                    const variant = variants.find(v =>
                        v.color.toLowerCase().trim() === selectedColor.toLowerCase().trim() &&
                        v.talla === size &&
                        v.stock > 0
                    );
                    if (variant) available = true;
                }

                if (!selectedColor) {
                    div.classList.add('disabled');
                } else if (!available) {
                    div.classList.add('disabled');
                } else {
                    div.onclick = () => selectSize(size, div);
                }

                if (selectedSize === size && available) div.classList.add('selected');
                sizeContainer.appendChild(div);
            });
        }

        function selectColor(colorClicked, element) {
            selectedColor = colorClicked;
            selectedSize = null;
            hiddenInput.value = '';

            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedColorText').innerText = selectedColor;
            document.getElementById('selectedSizeText').innerText = '';

            // --- LÓGICA DE IMAGEN CORREGIDA Y BLINDADA ---
            console.log("Buscando imagen para el color:", selectedColor);

            // Buscamos cualquier variante que coincida con el color (ignorando mayúsculas/espacios)
            // y que tenga una URL de imagen válida (no vacía).
            const variantWithImg = variants.find(v =>
                v.color.toLowerCase().trim() === selectedColor.toLowerCase().trim() &&
                v.img &&
                v.img.trim() !== ''
            );

            if (variantWithImg) {
                console.log("Imagen específica encontrada:", variantWithImg.img);
                changeMainImage(variantWithImg.img);
            } else {
                console.log("No hay imagen específica para este color, volviendo a la original.");
                changeMainImage(mainProductImage);
            }

            renderSizes();
            updateButtonState();
        }

        function selectSize(size, element) {
            selectedSize = size;
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedSizeText').innerText = size;
            updateButtonState();
        }

        function updateButtonState() {
            document.getElementById('colorError').style.display = 'none';
            document.getElementById('sizeError').style.display = 'none';
            stockDisplay.style.display = 'none';

            if (selectedColor && selectedSize) {
                // Comparación segura para encontrar la variante final
                const finalVariant = variants.find(v =>
                    v.color.toLowerCase().trim() === selectedColor.toLowerCase().trim() &&
                    v.talla === selectedSize
                );

                if (finalVariant) {
                    hiddenInput.value = finalVariant.id;
                    btnAdd.disabled = false;
                    btnAdd.innerText = "Agregar a la bolsa";
                    btnAdd.style.background = "#111827";

                    stockDisplay.style.display = 'block';
                    if(finalVariant.stock < 5) {
                        stockDisplay.innerText = `¡Solo quedan ${finalVariant.stock} unidades!`;
                        stockDisplay.style.color = '#dc2626';
                    } else {
                        stockDisplay.innerText = 'Stock Disponible';
                        stockDisplay.style.color = '#166534';
                    }
                }
            } else {
                btnAdd.disabled = true;
                btnAdd.innerText = "Seleccionar opciones";
                btnAdd.style.background = "#e5e7eb";
            }
        }

        function changeMainImage(url) {
            if (url && url.trim() !== '') {
                const img = document.getElementById('mainImage');
                img.style.opacity = 0;
                setTimeout(() => {
                    img.src = url;
                    img.style.opacity = 1;
                }, 150);
            }
        }

        function submitForm() {
            if (!selectedColor) return document.getElementById('colorError').style.display = 'block';
            if (!selectedSize) return document.getElementById('sizeError').style.display = 'block';
            document.getElementById('addToCartForm').submit();
        }

        document.addEventListener("DOMContentLoaded", init);
        /*]]>*/
    </script>
</section>
</body>
</html>