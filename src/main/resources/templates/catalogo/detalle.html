<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base/base-cliente}">
<head>
    <title th:text="${producto != null ? producto.nombre : 'Detalle del Producto'}"></title>
    <style>
        /* ESTILOS BASE */
        :root { --primary: #111827; --border: #e5e7eb; --radius: 8px; }
        .product-detail-page { padding: 3rem 1rem; max-width: 1200px; margin: 0 auto; }

        /* Layout */
        .grid-layout { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 968px) { .grid-layout { grid-template-columns: 100px 1fr 400px; gap: 1rem; } }

        /* Galería */
        .thumbnails { display: flex; flex-direction: row; gap: 10px; overflow-x: auto; }
        @media (min-width: 968px) { .thumbnails { flex-direction: column; overflow-y: auto; max-height: 600px; } }

        .thumb-btn { width: 80px; height: 80px; border-radius: var(--radius); border: 1px solid transparent; cursor: pointer; overflow: hidden; transition: 0.2s; flex-shrink: 0; }
        .thumb-btn:hover, .thumb-btn.active { border-color: var(--primary); }
        .thumb-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* Imagen Principal */
        .main-image-container { position: relative; background: #f9fafb; border-radius: 12px; overflow: hidden; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; }
        .main-image-container img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }

        /* Info */
        .product-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; line-height: 1.1; }
        .product-price { font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 2rem; }

        /* Selectores */
        .selector-label { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        .color-grid, .size-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; }

        .color-option, .size-option {
            padding: 8px 16px; border: 1px solid var(--border); border-radius: 6px;
            cursor: pointer; background: white; transition: 0.2s; user-select: none; font-size: 0.9rem;
        }
        .color-option:hover, .size-option:hover { border-color: #9ca3af; }
        .color-option.selected, .size-option.selected { border-color: var(--primary); background: var(--primary); color: white; }
        .size-option.disabled { opacity: 0.4; cursor: not-allowed; background: #f3f4f6; text-decoration: line-through; border-color: #e5e7eb; }

        .error-msg { color: #dc2626; font-size: 0.85rem; display: none; margin-top: 5px; font-weight: 500; }

        .add-btn { width: 100%; background: var(--primary); color: white; padding: 1.2rem; border-radius: 50px; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .add-btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }

        .desc-text { line-height: 1.7; color: #4b5563; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border); }
    </style>
</head>
<body>
<section layout:fragment="content">

    <div th:if="${producto != null}" class="product-detail-page">

        <div th:if="${successMessage}" class="alert alert-success mb-4" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-error mb-4" th:text="${errorMessage}"></div>

        <div class="grid-layout">

            <div class="thumbnails">
                <div class="thumb-btn active"
                     th:data-img="${producto.imagenUrl}"
                     onclick="changeMainImage(this.getAttribute('data-img'))">
                    <img th:src="${producto.imagenUrl}" onerror="this.src='https://placehold.co/80';">
                </div>

                <th:block th:each="v : ${producto.variantes}">
                    <div th:if="${v != null and v.imagenUrl != null and v.imagenUrl != ''}"
                         class="thumb-btn"
                         th:data-img="${v.imagenUrl}"
                         onclick="changeMainImage(this.getAttribute('data-img'))">
                        <img th:src="${v.imagenUrl}" onerror="this.style.display='none'">
                    </div>
                </th:block>
            </div>

            <div class="main-image-container">
                <img id="mainImage" th:src="${producto.imagenUrl}" onerror="this.src='https://placehold.co/600x600?text=No+Image';">
            </div>

            <div class="info-panel">
                <h1 class="product-title" th:text="${producto.nombre}"></h1>
                <div class="text-gray-500 mb-2" th:text="${producto.categoria?.nombre}"></div>
                <div class="product-price" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 'POINT', 2, 'COMMA')}"></div>

                <form th:action="@{/carrito/agregar/{id}(id=${producto.id})}" method="post" id="addToCartForm">
                    <input type="hidden" name="productoVarianteId" id="selectedVariantId">
                    <input type="hidden" name="cantidad" value="1">

                    <div class="selector-label">
                        <span>Color</span>
                        <span id="selectedColorText" class="font-normal text-gray-500"></span>
                    </div>
                    <div class="color-grid" id="colorContainer"></div>
                    <div id="colorError" class="error-msg">Selecciona un color</div>

                    <div class="selector-label">
                        <span>Talla</span>
                        <span id="selectedSizeText" class="font-normal text-gray-500"></span>
                    </div>
                    <div class="size-grid" id="sizeContainer"></div>
                    <div id="sizeError" class="error-msg">Selecciona una talla</div>

                    <button type="button" id="btnAddToCart" class="add-btn" disabled onclick="submitForm()">
                        Seleccionar opciones
                    </button>

                    <p id="stockDisplay" class="text-center mt-3 text-sm font-medium" style="display:none;"></p>
                </form>

                <p class="desc-text" th:text="${producto.descripcion}"></p>
            </div>
        </div>
    </div>

    <div th:if="${producto == null}" class="text-center py-20">
        <h2 class="text-2xl font-bold text-red-600">Producto no encontrado</h2>
        <a href="/catalogo" class="btn btn-primary mt-4">Volver al catálogo</a>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const variants = [];

        /* LÓGICA SEGURA DE EXTRACCIÓN DE DATOS */
        /*[# th:if="${producto != null}"]*/
        /*[# th:each="v : ${producto.variantes}"]*/
        // Verificamos que v no sea nulo antes de escribir el JS
        /*[# th:if="${v != null and v.activo}"]*/
        try {
            variants.push({
                id: [[${v.id}]],
                // Usamos el operador seguro de Thymeleaf (?.) por si acaso
                color: [[${v.color}]],
                talla: [[${v.talla}]],
                img: [[${v.imagenUrl}]],
                stock: [[${v.stock != null ? v.stock : 0}]]
            });
        } catch (e) {
            console.error("Error procesando variante", e);
        }
        /*[/]*/
        /*[/]*/
        /*[/]*/

        // Referencias DOM
        const colorContainer = document.getElementById('colorContainer');
        const sizeContainer = document.getElementById('sizeContainer');
        const mainImage = document.getElementById('mainImage');
        const hiddenInput = document.getElementById('selectedVariantId');
        const btnAdd = document.getElementById('btnAddToCart');
        const stockDisplay = document.getElementById('stockDisplay');

        let selectedColor = null;
        let selectedSize = null;

        function init() {
            if(variants.length === 0) {
                if(stockDisplay) {
                    stockDisplay.style.display = 'block';
                    stockDisplay.innerText = 'No hay stock disponible actualmente.';
                    stockDisplay.style.color = '#dc2626';
                }
                return;
            }
            renderColors();
            renderSizes();
        }

        function renderColors() {
            const colors = [...new Set(variants.map(v => v.color))].sort();
            colorContainer.innerHTML = '';
            colors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'color-option';
                div.innerText = color;
                div.onclick = () => selectColor(color, div);
                colorContainer.appendChild(div);
            });
        }

        function renderSizes() {
            const allSizes = [...new Set(variants.map(v => v.talla))].sort((a, b) => a - b);
            sizeContainer.innerHTML = '';

            allSizes.forEach(size => {
                const div = document.createElement('div');
                div.className = 'size-option';
                div.innerText = size;

                // Verificar disponibilidad
                let available = false;
                if (selectedColor) {
                    const variant = variants.find(v => v.color === selectedColor && v.talla === size && v.stock > 0);
                    if (variant) available = true;
                }

                // Estilos
                if (!selectedColor) {
                    div.classList.add('disabled'); // Bloqueado hasta elegir color
                } else if (!available) {
                    div.classList.add('disabled'); // Sin stock para ese color
                } else {
                    div.onclick = () => selectSize(size, div);
                }

                if (selectedSize === size && available) div.classList.add('selected');

                sizeContainer.appendChild(div);
            });
        }

        function selectColor(color, element) {
            selectedColor = color;
            selectedSize = null; // Reset talla
            hiddenInput.value = '';

            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedColorText').innerText = color;
            document.getElementById('selectedSizeText').innerText = '';

            // Cambiar imagen si existe para este color
            const variantWithImg = variants.find(v => v.color === color && v.img && v.img !== '');
            if (variantWithImg) changeMainImage(variantWithImg.img);

            renderSizes();
            updateButtonState();
        }

        function selectSize(size, element) {
            selectedSize = size;
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedSizeText').innerText = size;

            updateButtonState();
        }

        function updateButtonState() {
            document.getElementById('colorError').style.display = 'none';
            document.getElementById('sizeError').style.display = 'none';
            stockDisplay.style.display = 'none';

            if (selectedColor && selectedSize) {
                const finalVariant = variants.find(v => v.color === selectedColor && v.talla === selectedSize);

                if (finalVariant) {
                    hiddenInput.value = finalVariant.id;
                    btnAdd.disabled = false;
                    btnAdd.innerText = "Agregar a la bolsa";
                    btnAdd.style.background = "#111827";

                    stockDisplay.style.display = 'block';
                    if(finalVariant.stock < 5) {
                        stockDisplay.innerText = `¡Solo quedan ${finalVariant.stock} unidades!`;
                        stockDisplay.style.color = '#dc2626';
                    } else {
                        stockDisplay.innerText = 'Stock Disponible';
                        stockDisplay.style.color = '#166534';
                    }
                }
            } else {
                btnAdd.disabled = true;
                btnAdd.innerText = "Seleccionar opciones";
                btnAdd.style.background = "#e5e7eb";
            }
        }

        function changeMainImage(url) {
            if (url) {
                const img = document.getElementById('mainImage');
                img.style.opacity = 0;
                setTimeout(() => { img.src = url; img.style.opacity = 1; }, 150);
            }
        }

        function submitForm() {
            if (!selectedColor) return document.getElementById('colorError').style.display = 'block';
            if (!selectedSize) return document.getElementById('sizeError').style.display = 'block';
            document.getElementById('addToCartForm').submit();
        }

        // Inicializar
        document.addEventListener("DOMContentLoaded", init);
        /*]]>*/
    </script>
</section>
</body>
</html>