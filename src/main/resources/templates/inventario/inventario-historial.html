<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base/base-admin}">
<head>
    <title>Historial de Inventario</title>
    <style>
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .stat-card-title { font-size: 0.875rem; color: #64748b; text-transform: uppercase; font-weight: 600; margin-bottom: 0.5rem; }
        .stat-card-value { font-size: 2.25rem; font-weight: 700; line-height: 1; }
        .stat-card-value.gastado { color: #ef4444; }
        .stat-card-value.ingresado { color: #22c55e; }
        .stat-card-value.neto { color: #3b82f6; }
        .admin-card { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 2rem; }
        .filter-form { padding: 1.5rem; }
        .filter-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .filter-form .label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #334155; }
        .filter-form .input-field { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; background-color: #f8fafc; color: #334155; }
        .filter-form-buttons { display: flex; align-items: flex-end; gap: 0.5rem; }
        .tipo-entrada { color: #22c55e; font-weight: 700; }
        .tipo-salida { color: #ef4444; font-weight: 700; }

        /* Estilo para los stocks */
        .stock-val { font-family: monospace; font-weight: 600; color: #475569; }
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="admin-header">
        <h1 class="admin-title">Historial y Estad√≠sticas</h1>
        <a th:href="@{/admin/inventario}" class="btn btn-secondary">Volver a Inventario</a>
    </div>

    <div class="stats-grid" th:object="${estadisticas}">
        <div class="stat-card">
            <div class="stat-card-title">Total Gastado (Costos)</div>
            <div class="stat-card-value gastado" th:text="|-$${#numbers.formatDecimal(estadisticas.totalGastado, 1, 'COMMA', 2, 'POINT')}|">-$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-title">Total Ingresado (Ventas)</div>
            <div class="stat-card-value ingresado" th:text="|$${#numbers.formatDecimal(estadisticas.totalIngresado, 1, 'COMMA', 2, 'POINT')}|">+$0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-title">Balance</div>
            <div class="stat-card-value neto" th:text="|$${#numbers.formatDecimal(estadisticas.totalIngresado - estadisticas.totalGastado, 1, 'COMMA', 2, 'POINT')}|">$0.00</div>
        </div>
    </div>

    <div class="admin-card">
        <form th:action="@{/admin/inventario/historial}" method="get" class="filter-form">
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem;">Filtrar Historial</h2>
            <div class="filter-form-grid">
                <div class="form-group">
                    <label for="fechaDesde" class="label">Fecha Desde</label>
                    <input type="date" id="fechaDesde" name="fechaDesde" class="input-field" th:value="${fechaDesdeParam}">
                </div>
                <div class="form-group">
                    <label for="fechaHasta" class="label">Fecha Hasta</label>
                    <input type="date" id="fechaHasta" name="fechaHasta" class="input-field" th:value="${fechaHastaParam}">
                </div>
                <div class="form-group">
                    <label for="productoNombre" class="label">Producto</label>
                    <input type="text" id="productoNombre" name="productoNombre" class="input-field" placeholder="Buscar por nombre..." th:value="${productoNombreParam}">
                </div>
                <div class="form-group">
                    <label for="tipo" class="label">Tipo de Movimiento</label>
                    <select id="tipo" name="tipo" class="input-field">
                        <option value="">Todos</option>
                        <option value="Entrada" th:selected="${tipoParam == 'Entrada'}">Entrada</option>
                        <option value="Salida" th:selected="${tipoParam == 'Salida'}">Salida</option>
                    </select>
                </div>
                <div class="filter-form-buttons">
                    <button type="submit" class="btn btn-primary" style="flex-grow: 1;">Filtrar</button>
                    <a th:href="@{/admin/inventario/historial}" class="btn btn-secondary" style="flex-grow: 1; text-align: center; line-height: 1.5;">Limpiar</a>
                </div>
            </div>
        </form>
    </div>

    <div class="admin-card">
        <div class="overflow-x-auto">
            <table class="admin-table">
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Producto</th>
                    <th>Tipo</th>

                    <th class="text-center">Stock Inicial</th>
                    <th class="text-center">Cambio</th>
                    <th class="text-center">Stock Final</th>

                    <th style="text-align: right;">$ Total</th>
                    <th>Detalle</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${historial}">
                    <td th:text="${#temporals.format(item.fecha, 'dd/MM HH:mm')}"></td>

                    <td th:text="${item.productoNombre}"></td>

                    <td>
                        <span th:if="${item.tipo == 'Entrada'}" class="badge bg-green-100 text-green-800" style="padding: 2px 6px; border-radius: 4px; background: #dcfce7; color: #166534; font-size: 0.75rem;">Entrada</span>
                        <span th:if="${item.tipo == 'Salida'}" class="badge bg-red-100 text-red-800" style="padding: 2px 6px; border-radius: 4px; background: #fee2e2; color: #991b1b; font-size: 0.75rem;">Salida</span>
                    </td>

                    <td class="text-center stock-val">
                        <span th:if="${item.stockAnterior != null}" th:text="${item.stockAnterior}"></span>
                        <span th:if="${item.stockAnterior == null}" class="text-gray-400">-</span>
                    </td>

                    <td class="text-center" style="font-weight: bold;">
                        <span th:if="${item.tipo == 'Entrada'}" class="tipo-entrada" th:text="'+' + ${item.cantidad}"></span>
                        <span th:if="${item.tipo == 'Salida'}" class="tipo-salida" th:text="'-' + ${item.cantidad}"></span>
                    </td>

                    <td class="text-center stock-val">
                        <span th:if="${item.stockNuevo != null}" th:text="${item.stockNuevo}"></span>
                        <span th:if="${item.stockNuevo == null}" class="text-gray-400">-</span>
                    </td>

                    <td style="text-align: right;">
                         <span th:if="${item.tipo == 'Salida'}" class="tipo-entrada"
                               th:text="'+$' + ${#numbers.formatDecimal(item.valorMonetario, 0, 'COMMA', 0, 'POINT')}"></span>
                        <span th:if="${item.tipo == 'Entrada'}" class="tipo-salida"
                              th:text="'-$' + ${#numbers.formatDecimal(item.valorMonetario, 0, 'COMMA', 0, 'POINT')}"></span>
                    </td>

                    <td th:text="${item.descripcion}" class="text-xs text-gray-500"></td>
                </tr>

                <tr th:if="${#lists.isEmpty(historial)}">
                    <td colspan="8" style="text-align: center; padding: 2rem;">
                        No hay registros en el historial.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>
</body>
</html>